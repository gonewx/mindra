# Mindra Android Fastlane é…ç½®
# ç”¨äºè‡ªåŠ¨åŒ–æ„å»ºå’Œå‘å¸ƒæµç¨‹

default_platform(:android)

platform :android do
  # åº”ç”¨åŸºæœ¬ä¿¡æ¯
  APP_IDENTIFIER = "com.mindra.app"
  AAB_PATH = "../build/app/outputs/bundle/release/app-release.aab"
  APK_PATH = "../build/app/outputs/flutter-apk/app-release.apk"
  
  # æ„å»ºå‰å‡†å¤‡
  before_all do
    # ç¡®ä¿åœ¨æ­£ç¡®çš„ç›®å½•
    ensure_git_status_clean unless ENV["SKIP_GIT_CHECK"]
    
    # æ£€æŸ¥å¿…è¦æ–‡ä»¶
    unless File.exist?(AAB_PATH)
      UI.user_error!("AAB æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œæ„å»ºè„šæœ¬")
    end
  end

  # å†…éƒ¨æµ‹è¯•å‘å¸ƒ
  desc "å‘å¸ƒåˆ°å†…éƒ¨æµ‹è¯•è½¨é“"
  lane :internal do
    deploy(track: "internal")
  end

  # Alpha æµ‹è¯•å‘å¸ƒ
  desc "å‘å¸ƒåˆ° Alpha æµ‹è¯•è½¨é“"
  lane :alpha do
    deploy(track: "alpha")
  end

  # Beta æµ‹è¯•å‘å¸ƒ
  desc "å‘å¸ƒåˆ° Beta æµ‹è¯•è½¨é“"
  lane :beta do
    deploy(track: "beta")
  end

  # æ­£å¼å‘å¸ƒ
  desc "å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒ"
  lane :production do
    # ç”Ÿäº§å‘å¸ƒéœ€è¦é¢å¤–ç¡®è®¤
    UI.confirm("ç¡®å®šè¦å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒå—ï¼Ÿè¿™å°†å¯¹æ‰€æœ‰ç”¨æˆ·å¯è§ã€‚")
    deploy(track: "production")
  end

  # é€šç”¨å‘å¸ƒæ–¹æ³•
  desc "å‘å¸ƒåˆ°æŒ‡å®šè½¨é“"
  lane :deploy do |options|
    track = options[:track] || "internal"
    
    UI.message("å¼€å§‹å‘å¸ƒåˆ° #{track} è½¨é“...")
    
    # éªŒè¯ AAB æ–‡ä»¶
    validate_aab
    
    # ä¸Šä¼ åˆ° Google Play
    upload_to_play_store(
      track: track,
      aab: AAB_PATH,
      skip_upload_apk: true,
      skip_upload_metadata: false,
      skip_upload_changelogs: false,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: get_release_status(track),
      version_name: get_version_name,
      version_code: get_version_code
    )
    
    UI.success("æˆåŠŸå‘å¸ƒåˆ° #{track} è½¨é“ï¼")
    
    # å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
    send_notification(track: track) if ENV["ENABLE_NOTIFICATIONS"]
  end

  # éªŒè¯ AAB æ–‡ä»¶
  desc "éªŒè¯ AAB æ–‡ä»¶"
  lane :validate_aab do
    UI.message("éªŒè¯ AAB æ–‡ä»¶...")
    
    # æ£€æŸ¥æ–‡ä»¶å­˜åœ¨
    unless File.exist?(AAB_PATH)
      UI.user_error!("AAB æ–‡ä»¶ä¸å­˜åœ¨: #{AAB_PATH}")
    end
    
    # æ£€æŸ¥æ–‡ä»¶å¤§å°
    file_size = File.size(AAB_PATH)
    if file_size > 150 * 1024 * 1024  # 150MB
      UI.user_error!("AAB æ–‡ä»¶è¿‡å¤§: #{file_size / 1024 / 1024}MB")
    end
    
    UI.success("AAB æ–‡ä»¶éªŒè¯é€šè¿‡")
  end

  # è·å–ç‰ˆæœ¬åç§°
  desc "è·å–ç‰ˆæœ¬åç§°"
  lane :get_version_name do
    pubspec_path = "../pubspec.yaml"
    pubspec_content = File.read(pubspec_path)
    version_line = pubspec_content.match(/^version:\s*(.+)$/)
    
    if version_line
      version_full = version_line[1].strip
      version_name = version_full.split('+')[0]
      return version_name
    else
      UI.user_error!("æ— æ³•ä» pubspec.yaml è·å–ç‰ˆæœ¬å·")
    end
  end

  # è·å–ç‰ˆæœ¬ä»£ç 
  desc "è·å–ç‰ˆæœ¬ä»£ç "
  lane :get_version_code do
    pubspec_path = "../pubspec.yaml"
    pubspec_content = File.read(pubspec_path)
    version_line = pubspec_content.match(/^version:\s*(.+)$/)
    
    if version_line
      version_full = version_line[1].strip
      if version_full.include?('+')
        version_code = version_full.split('+')[1].to_i
        return version_code
      else
        return 1
      end
    else
      UI.user_error!("æ— æ³•ä» pubspec.yaml è·å–ç‰ˆæœ¬ä»£ç ")
    end
  end

  # è·å–å‘å¸ƒçŠ¶æ€
  desc "è·å–å‘å¸ƒçŠ¶æ€"
  lane :get_release_status do |options|
    track = options[:track]
    
    case track
    when "internal"
      "completed"  # å†…éƒ¨æµ‹è¯•ç«‹å³å‘å¸ƒ
    when "alpha", "beta"
      "completed"  # æµ‹è¯•ç‰ˆæœ¬ç«‹å³å‘å¸ƒ
    when "production"
      "draft"      # ç”Ÿäº§ç‰ˆæœ¬å…ˆä¿å­˜ä¸ºè‰ç¨¿
    else
      "completed"
    end
  end

  # å‘é€é€šçŸ¥
  desc "å‘é€å‘å¸ƒé€šçŸ¥"
  lane :send_notification do |options|
    track = options[:track]
    version_name = get_version_name
    
    # Slack é€šçŸ¥ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
    if ENV["SLACK_URL"]
      slack(
        message: "Mindra Android #{version_name} å·²å‘å¸ƒåˆ° #{track} è½¨é“ ğŸš€",
        slack_url: ENV["SLACK_URL"],
        channel: "#releases",
        username: "Fastlane",
        icon_emoji: ":rocket:"
      )
    end
    
    # é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
    if ENV["NOTIFICATION_EMAIL"]
      # è¿™é‡Œå¯ä»¥æ·»åŠ é‚®ä»¶é€šçŸ¥é€»è¾‘
      UI.message("å‘é€é‚®ä»¶é€šçŸ¥åˆ°: #{ENV['NOTIFICATION_EMAIL']}")
    end
  end

  # æ„å»ºå’Œå‘å¸ƒä¸€ä½“åŒ–
  desc "æ„å»ºå¹¶å‘å¸ƒ"
  lane :build_and_deploy do |options|
    track = options[:track] || "internal"
    
    UI.message("å¼€å§‹æ„å»ºå’Œå‘å¸ƒæµç¨‹...")
    
    # åˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•
    Dir.chdir("..") do
      # è¿è¡Œ Flutter æ„å»º
      sh("flutter", "clean")
      sh("flutter", "pub", "get")
      sh("flutter", "build", "appbundle", "--release")
    end
    
    # å‘å¸ƒ
    deploy(track: track)
  end

  # é”™è¯¯å¤„ç†
  error do |lane, exception|
    UI.error("å‘å¸ƒå¤±è´¥: #{exception.message}")
    
    # å‘é€é”™è¯¯é€šçŸ¥
    if ENV["SLACK_URL"]
      slack(
        message: "âŒ Mindra Android å‘å¸ƒå¤±è´¥: #{exception.message}",
        slack_url: ENV["SLACK_URL"],
        channel: "#releases",
        username: "Fastlane",
        icon_emoji: ":x:",
        success: false
      )
    end
  end

  # å‘å¸ƒåæ¸…ç†
  after_all do |lane|
    UI.success("å‘å¸ƒæµç¨‹å®Œæˆï¼")
  end
end

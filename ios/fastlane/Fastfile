# Mindra iOS Fastlane é…ç½®
# ç”¨äºè‡ªåŠ¨åŒ–æ„å»ºå’Œå‘å¸ƒæµç¨‹

default_platform(:ios)

platform :ios do
  # åº”ç”¨åŸºæœ¬ä¿¡æ¯
  APP_IDENTIFIER = "com.mindra.app"
  WORKSPACE = "Runner.xcworkspace"
  SCHEME = "Runner"
  
  # æ„å»ºå‰å‡†å¤‡
  before_all do
    # ç¡®ä¿åœ¨æ­£ç¡®çš„ç›®å½•
    ensure_git_status_clean unless ENV["SKIP_GIT_CHECK"]
    
    # è®¾ç½® Xcode é¡¹ç›®
    setup_ci if ENV["CI"]
  end

  # è¯ä¹¦å’Œé…ç½®æ–‡ä»¶ç®¡ç†
  desc "åŒæ­¥è¯ä¹¦å’Œé…ç½®æ–‡ä»¶"
  lane :certificates do
    # ä½¿ç”¨ match ç®¡ç†è¯ä¹¦ï¼ˆæ¨èï¼‰
    if ENV["MATCH_GIT_URL"]
      match(
        type: "appstore",
        app_identifier: APP_IDENTIFIER,
        readonly: true
      )
    else
      # æ‰‹åŠ¨ç®¡ç†è¯ä¹¦
      UI.message("ä½¿ç”¨æ‰‹åŠ¨ç®¡ç†çš„è¯ä¹¦")
      # è¿™é‡Œå¯ä»¥æ·»åŠ æ‰‹åŠ¨è¯ä¹¦æ£€æŸ¥é€»è¾‘
    end
  end

  # æ„å»ºåº”ç”¨
  desc "æ„å»º iOS åº”ç”¨"
  lane :build do
    # åŒæ­¥è¯ä¹¦
    certificates
    
    # åˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•è¿›è¡Œ Flutter æ„å»º
    Dir.chdir("..") do
      sh("flutter", "clean")
      sh("flutter", "pub", "get")
      sh("flutter", "build", "ios", "--release")
    end
    
    # ä½¿ç”¨ Xcode æ„å»º
    build_app(
      workspace: WORKSPACE,
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      output_name: "Runner.ipa",
      include_bitcode: false,
      include_symbols: true
    )
  end

  # TestFlight å‘å¸ƒ
  desc "å‘å¸ƒåˆ° TestFlight"
  lane :beta do
    # æ„å»ºåº”ç”¨
    build
    
    # ä¸Šä¼ åˆ° TestFlight
    upload_to_testflight(
      ipa: "../build/ios/ipa/Runner.ipa",
      skip_waiting_for_build_processing: false,
      skip_submission: true,
      distribute_external: false,
      notify_external_testers: false,
      changelog: get_changelog
    )
    
    UI.success("æˆåŠŸå‘å¸ƒåˆ° TestFlightï¼")
    
    # å‘é€é€šçŸ¥
    send_notification(target: "TestFlight") if ENV["ENABLE_NOTIFICATIONS"]
  end

  # App Store å‘å¸ƒ
  desc "å‘å¸ƒåˆ° App Store"
  lane :release do
    # ç¡®è®¤æ“ä½œ
    UI.confirm("ç¡®å®šè¦å‘å¸ƒåˆ° App Store å—ï¼Ÿè¿™å°†å¯¹æ‰€æœ‰ç”¨æˆ·å¯è§ã€‚")
    
    # æ„å»ºåº”ç”¨
    build
    
    # ä¸Šä¼ åˆ° App Store
    upload_to_app_store(
      ipa: "../build/ios/ipa/Runner.ipa",
      skip_metadata: false,
      skip_screenshots: true,
      submit_for_review: false,  # æ‰‹åŠ¨æäº¤å®¡æ ¸
      automatic_release: false,
      force: true
    )
    
    UI.success("æˆåŠŸä¸Šä¼ åˆ° App Storeï¼")
    UI.message("è¯·åœ¨ App Store Connect ä¸­æ‰‹åŠ¨æäº¤å®¡æ ¸")
    
    # å‘é€é€šçŸ¥
    send_notification(target: "App Store") if ENV["ENABLE_NOTIFICATIONS"]
  end

  # ä»…æ„å»ºä¸ä¸Šä¼ 
  desc "ä»…æ„å»ºåº”ç”¨"
  lane :build_only do
    build
    UI.success("æ„å»ºå®Œæˆï¼ŒIPA æ–‡ä»¶ä½äº: ../build/ios/ipa/Runner.ipa")
  end

  # è·å–ç‰ˆæœ¬å·
  desc "è·å–åº”ç”¨ç‰ˆæœ¬å·"
  lane :get_version_number do
    pubspec_path = "../pubspec.yaml"
    pubspec_content = File.read(pubspec_path)
    version_line = pubspec_content.match(/^version:\s*(.+)$/)
    
    if version_line
      version_full = version_line[1].strip
      version_name = version_full.split('+')[0]
      return version_name
    else
      UI.user_error!("æ— æ³•ä» pubspec.yaml è·å–ç‰ˆæœ¬å·")
    end
  end

  # è·å–æ„å»ºå·
  desc "è·å–åº”ç”¨æ„å»ºå·"
  lane :get_build_number do
    pubspec_path = "../pubspec.yaml"
    pubspec_content = File.read(pubspec_path)
    version_line = pubspec_content.match(/^version:\s*(.+)$/)
    
    if version_line
      version_full = version_line[1].strip
      if version_full.include?('+')
        build_number = version_full.split('+')[1]
        return build_number
      else
        return "1"
      end
    else
      UI.user_error!("æ— æ³•ä» pubspec.yaml è·å–æ„å»ºå·")
    end
  end

  # è·å–æ›´æ–°æ—¥å¿—
  desc "è·å–æ›´æ–°æ—¥å¿—"
  lane :get_changelog do
    changelog_path = "../CHANGELOG.md"
    
    if File.exist?(changelog_path)
      changelog_content = File.read(changelog_path)
      # æå–æœ€æ–°ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
      lines = changelog_content.split("\n")
      changelog_lines = []
      found_version = false
      
      lines.each do |line|
        if line.start_with?("## ") && found_version
          break
        elsif line.start_with?("## ")
          found_version = true
          next
        elsif found_version && !line.strip.empty?
          changelog_lines << line
        end
      end
      
      if changelog_lines.empty?
        return "Bug fixes and performance improvements"
      else
        return changelog_lines.join("\n").strip
      end
    else
      return "Bug fixes and performance improvements"
    end
  end

  # æ›´æ–°ç‰ˆæœ¬å·
  desc "æ›´æ–°ç‰ˆæœ¬å·"
  lane :bump_version do |options|
    version_type = options[:type] || "patch"  # major, minor, patch
    
    current_version = get_version_number
    current_build = get_build_number.to_i
    
    # è®¡ç®—æ–°ç‰ˆæœ¬å·
    version_parts = current_version.split('.').map(&:to_i)
    
    case version_type
    when "major"
      version_parts[0] += 1
      version_parts[1] = 0
      version_parts[2] = 0
    when "minor"
      version_parts[1] += 1
      version_parts[2] = 0
    when "patch"
      version_parts[2] += 1
    end
    
    new_version = version_parts.join('.')
    new_build = current_build + 1
    new_version_full = "#{new_version}+#{new_build}"
    
    # æ›´æ–° pubspec.yaml
    pubspec_path = "../pubspec.yaml"
    pubspec_content = File.read(pubspec_path)
    updated_content = pubspec_content.gsub(/^version:\s*.+$/, "version: #{new_version_full}")
    File.write(pubspec_path, updated_content)
    
    UI.success("ç‰ˆæœ¬å·å·²æ›´æ–°: #{current_version}+#{current_build} -> #{new_version_full}")
    
    return new_version_full
  end

  # å‘é€é€šçŸ¥
  desc "å‘é€å‘å¸ƒé€šçŸ¥"
  lane :send_notification do |options|
    target = options[:target]
    version = get_version_number
    build = get_build_number
    
    # Slack é€šçŸ¥
    if ENV["SLACK_URL"]
      slack(
        message: "Mindra iOS #{version} (#{build}) å·²å‘å¸ƒåˆ° #{target} ğŸš€",
        slack_url: ENV["SLACK_URL"],
        channel: "#releases",
        username: "Fastlane",
        icon_emoji: ":rocket:"
      )
    end
    
    # é‚®ä»¶é€šçŸ¥
    if ENV["NOTIFICATION_EMAIL"]
      UI.message("å‘é€é‚®ä»¶é€šçŸ¥åˆ°: #{ENV['NOTIFICATION_EMAIL']}")
    end
  end

  # è¿è¡Œæµ‹è¯•
  desc "è¿è¡Œå•å…ƒæµ‹è¯•"
  lane :test do
    Dir.chdir("..") do
      sh("flutter", "test")
    end
  end

  # å®Œæ•´çš„å‘å¸ƒæµç¨‹
  desc "å®Œæ•´çš„å‘å¸ƒæµç¨‹ï¼ˆæ„å»º + TestFlightï¼‰"
  lane :deploy do |options|
    # è¿è¡Œæµ‹è¯•
    test unless ENV["SKIP_TESTS"]
    
    # å‘å¸ƒåˆ° TestFlight
    beta
    
    UI.success("å®Œæ•´å‘å¸ƒæµç¨‹å®Œæˆï¼")
  end

  # é”™è¯¯å¤„ç†
  error do |lane, exception|
    UI.error("å‘å¸ƒå¤±è´¥: #{exception.message}")
    
    # å‘é€é”™è¯¯é€šçŸ¥
    if ENV["SLACK_URL"]
      slack(
        message: "âŒ Mindra iOS å‘å¸ƒå¤±è´¥: #{exception.message}",
        slack_url: ENV["SLACK_URL"],
        channel: "#releases",
        username: "Fastlane",
        icon_emoji: ":x:",
        success: false
      )
    end
  end

  # å‘å¸ƒåæ¸…ç†
  after_all do |lane|
    UI.success("å‘å¸ƒæµç¨‹å®Œæˆï¼")
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    clean_build_artifacts_action
  end
end
